<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>T17 — Obstáculo + Game Over</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
</head>

<body>
<script>


// Sol y luna

let xS, yS, dS, rS, vS;
let xL, yL, dL, rL, vL;

// Calendario
let dia, mes, anio;

// Stickman
let xP, yP, S, vP;
let rHead, bodyL, armL, legL;
let hipY, shoulderY, headY;

// Suelo
let groundY;
let vY, jumpV, g;

// Disparo
let xD, yD, tD, vD;
let disparoActivo;

// Objetivo
let xO, yO, wO, hO, vO;

// Obstáculo
let xB, yB, wB, hB, vB;

// Puntos
let puntos;

// Estado del juego
let gameOver;

function setup() {
  createCanvas(300, 300);

  // Sol
  dS = min(width, height) * 0.2;
  rS = dS / 2;
  yS = height / 4;
  xS = -rS;
  vS = width / 400;

  // Luna
  dL = dS * 0.5;
  rL = dL / 2;
  yL = height / 3;
  xL = -width - rL;
  vL = vS;

  // Fecha
  dia = 1;
  mes = 3;
  anio = 2008;

  // Suelo
  groundY = height * 0.8;

  // Stickman
  S = 0.12 * min(width, height);
  xP = width * 0.25;
  yP = groundY;
  vP = width / 150;

  // Salto
  vY = 0;
  jumpV = -0.03 * height;
  g = 0.0016 * height;

  // Disparo
  tD = 0.03 * width;
  vD = 0.02 * height;
  disparoActivo = false;

  // Objetivo
  wO = 0.12 * width;
  hO = 0.06 * height;
  yO = random(height * 0.35, height * 0.55);
  xO = -wO;
  vO = random(1, 3);

  // Obstáculo
  wB = 10;
  hB = 10;
  yB = groundY - hB;
  xB = width + wB;
  vB = -0.9;

  // Puntos
  puntos = 0;

  // Estado
  gameOver = false;
}

function draw() {

 
  if (xS <= width + rS) background(80,160,255);
  else background(0);

  fill(20,120,40);
  rect(0, groundY, width, height - groundY);

  dibujarSol();
  dibujarLuna();


  if (!gameOver) {

    // Sol y luna
    xS += vS;
    xL += vL;

    if (xS >= 2 * width + rS) {
      xS = -rS;
      xL = -width - rL;
      dia++;
      if (dia > 30) { dia = 1; mes++; }
      if (mes > 12) { mes = 1; anio++; }
    }

    // Objetivo
    xO += vO;

    if (xO > width + wO) {
      xO = -wO;
      vO = random(1, 3);
    }

    if (xO < -wO) {
      xO = width + wO;
      vO = -random(1, 3);
    }

    // Disparo
    if (disparoActivo) {
      yD -= vD;

      if (xD > xO && xD < xO + wO &&
          yD - tD/2 < yO + hO &&
          yD + tD/2 > yO) {

        puntos++;
        disparoActivo = false;

        if (random() < 0.5) {
          xO = -wO;
          vO = random(1,3);
        } else {
          xO = width + wO;
          vO = -random(1,3);
        }
      }

      if (yD < 0) disparoActivo = false;
    }

    // Obstáculo
    xB += vB;

    if (xB > width + wB) {
      xB = -wB;
      vB = random(1.5, 3);
    }

    if (xB < -wB) {
      xB = width + wB;
      vB = -random(1.5, 3);
    }

    // Movimiento stickman
    if (keyIsDown(LEFT_ARROW)) xP -= vP;
    if (keyIsDown(RIGHT_ARROW)) xP += vP;
    xP = constrain(xP, 0, width);

    vY += g;
    yP += vY;
    if (yP > groundY) { yP = groundY; vY = 0; }

    // Colisión stickman–obstáculo
    let wP = 10;
    let hP = 10;

    let pLeft = xP - wP/2;
    let pRight = xP + wP/2;
    let pTop = yP - hP;
    let pBottom = yP;

    let bLeft = xB;
    let bRight = xB + wB;
    let bTop = yB;
    let bBottom = yB + hB;

    if (pRight > bLeft && pLeft < bRight &&
        pBottom > bTop && pTop < bBottom) {
      gameOver = true;
    }
  }


dibujarObjetivo();
if (disparoActivo) dibujarDisparo();
dibujarObstaculo();
dibujarStickman();
dibujarCalendario();
dibujarPuntos();

if (gameOver) {
  dibujarGameOver();
}

}



function dibujarSol() {
  noStroke();
  fill(245,234,10);
  circle(xS, yS, dS);
}

function dibujarLuna() {
  if (xS > width + rS) {
    fill(200);
    circle(xL, yL, dL);
  }
}

function dibujarObjetivo() {
  fill(255,0,0);
  rect(xO, yO, wO, hO, 8);
}

function dibujarDisparo() {
  fill(255,255,0);
  ellipse(xD, yD, tD);
}

function dibujarObstaculo() {
  fill(120);
  rect(xB, yB, wB, hB);
}

function dibujarStickman() {
  rHead = 0.20 * S;
  bodyL = 0.60 * S;
  armL  = 0.45 * S;
  legL  = 0.55 * S;

  hipY = yP - legL;
  shoulderY = hipY - bodyL;
  headY = shoulderY - rHead;

  stroke(255);
  strokeWeight(0.06 * S);
  noFill();

  circle(xP, headY, 2 * rHead);
  line(xP, shoulderY, xP, hipY);
  line(xP - 0.25*S, shoulderY, xP + 0.25*S, shoulderY);
  line(xP - 0.25*S, shoulderY, xP - 0.25*S, shoulderY + armL);
  line(xP + 0.25*S, shoulderY, xP + 0.25*S, shoulderY + armL);
  line(xP, hipY, xP - 0.18*S, yP);
  line(xP, hipY, xP + 0.18*S, yP);
}

function dibujarCalendario() {
  fill(255);
  textSize(14);
  text("Fecha: " + dia + "/" + mes + "/" + anio, 10, 18);
}

function dibujarPuntos() {
  fill(255);
  textSize(14);
  text("Puntos: " + puntos, 10, 36);
}

function dibujarGameOver() {
  fill(255,0,0);
  textSize(28);
  textAlign(CENTER);
  text("GAME OVER", width/2, height/2 - 10);
  textSize(16);
  text("Puntos: " + puntos, width/2, height/2 + 20);
  textAlign(LEFT);
}

function keyPressed() {

  if (!gameOver) {

    // Salto
    if (keyCode === UP_ARROW && yP === groundY) {
      vY = jumpV;
    }

    // Disparo
    if (key === ' ' && !disparoActivo) {
      xD = xP;
      yD = yP - legL - bodyL - rHead;
      disparoActivo = true;
    }
  }
}
</script>
</body>
    </html>